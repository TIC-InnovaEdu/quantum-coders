<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Runa Pachawan - Grupo 10</title>
    <link rel="stylesheet" href="estilos.css" />
    
    <!-- ADVERTENCIA PARA DESARROLLO LOCAL -->
    <!--
      Si ejecutas desde Live Server/local, los imports de Firebase pueden fallar por CORS.
      Para probar solo el juego, comenta el bloque <script type="module"> de Firebase.
      Cuando subas a GitHub Pages, funcionar谩 correctamente.
    -->

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs
      } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDAEwufyWjRtxvWpG3XiVD1TekeABK6Yjs",
        authDomain: "quantum-coders-3d4ca.firebaseapp.com",
        projectId: "quantum-coders-3d4ca",
        storageBucket: "quantum-coders-3d4ca.firebasestorage.app",
        messagingSenderId: "870775316580",
        appId: "1:870775316580:web:f62da8a3e62615eccc3f71",
        measurementId: "G-551EQ283PK"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      window.firebaseApp = app;
      window.firebaseDB = db;

      // Funciones de prueba (opcionales)
      window.testWrite = async function () {
        try {
          const ref = await addDoc(collection(db, "testCollection"), {
            createdAt: new Date().toISOString(),
            origin: location.href,
            note: "Prueba a producci贸n"
          });
          console.log("Documento creado en producci贸n con ID:", ref.id);
          return ref.id;
        } catch (err) {
          console.error("Error escribiendo a Firestore (producci贸n):", err);
          throw err;
        }
      };

      window.testRead = async function () {
        try {
          const snap = await getDocs(collection(db, "testCollection"));
          const arr = [];
          snap.forEach(d => arr.push({ id: d.id, data: d.data() }));
          console.log("Docs en testCollection (producci贸n):", arr);
          return arr;
        } catch (err) {
          console.error("Error leyendo de Firestore (producci贸n):", err);
          throw err;
        }
      };

      // Exponer funci贸n global para mostrar el modal y guardar score
      window.promptSaveScore = async function(score) {
        const modal = document.getElementById('saveScoreModal');
        const scoreInput = document.getElementById('scoreInput');
        const dateInput = document.getElementById('dateInput');
        const message = document.getElementById('saveScoreMessage');
        scoreInput.value = score;
        dateInput.value = new Date().toLocaleString();
        modal.setAttribute('aria-hidden', 'false');
        message.textContent = "";

        // Eliminar cualquier handler anterior
        document.getElementById('saveScoreForm').onsubmit = null;

        // Guardar en Firestore al enviar
        document.getElementById('saveScoreForm').onsubmit = async function(e) {
          e.preventDefault();
          const username = document.getElementById('usernameInput').value;
          const realname = document.getElementById('realnameInput').value;
          const score = parseInt(scoreInput.value, 10);
          const date = dateInput.value;

          try {
            await addDoc(collection(db, "scores"), {
              username,
              realname,
              score,
              date
            });
            message.textContent = "隆Puntuaci贸n guardada correctamente!";
            setTimeout(() => {
              modal.setAttribute('aria-hidden', 'true');
              location.reload();
            }, 1200);
          } catch (err) {
            message.textContent = "Error al guardar: " + err;
          }
        };

        // Cancelar y cerrar modal
        document.getElementById('modalCancel').onclick = function() {
          modal.setAttribute('aria-hidden', 'true');
        };
      };
    </script>
</head>
<body>
    <div id="menu" class="fullscreen">
        <h1 id="gameTitle">RUNA PACHAWAN</h1>
        <div class="menu-options">
            <button id="playButton">Jugar</button>
            <button id="exitButton">Salir</button>
        </div>
        <div class="controls">
            <h3>Controles:</h3>
            <p>    - Moverse</p>
            <p>A - Atacar</p>
            <p>B - Interactuar</p>
        </div>
    </div>
    <div id="game-container">
        <div class="background" id="background"></div>
        <div id="stage">
            <div id="floor"></div>
            <!-- Nivel 1 -->
            <div class="platforms-scene-1">
            </div>

            <!-- Plataformas visibles solo en escena 2 -->
            <div class="platforms-scene-2" style="display: none;">
                <!-- Plataforma 1 -->
                <div class="platform" style="left: 350px; bottom: 180px; width: 120px; height: 20px;"></div>
                <div class="blocker-wall" style="left: 350px; bottom: 100px; width: 120px; height: 80px;"></div>

                <!-- Plataforma 2 -->
                <div class="platform" style="left: 700px; bottom: 250px; width: 120px; height: 20px;"></div>
    
                <!-- Plataforma 3 -->
                <div class="platform" style="left: 900px; bottom: 390px; width: 120px; height: 20px;"></div>
            </div>
            
            <!--Scenario 3-->
            <div class="platforms-scene-3" style="display: none;">
                <!-- Plataforma izquierda -->
                <div class="platform" style="left: 200px; bottom: 200px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 200px; bottom: 320px; width: 120px; height: 20px;"></div>
                <!-- Plataforma derecha -->
                <div class="platform" style="left: 1200px; bottom: 200px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 1200px; bottom: 320px; width: 120px; height: 20px;"></div>
            </div>

            <!-- Nivel 4 -->
            <div class="platforms-scene-4" style="display: none;">
                <!-- Plataforma inicial -->
                <div class="platform green" style="left: 100px; bottom: 160px; width: 180px; height: 20px;"></div>
                 <!-- Plataforma peque帽a -->
                <div class="platform green" style="left: 400px; bottom: 300px; width: 80px; height: 20px;"></div>
                <!-- Plataforma mediana -->
                <div class="platform green" style="left: 650px; bottom: 220px; width: 120px; height: 20px;"></div>
                <div class="platform green" style="left: 950px; bottom: 150px; width: 80px; height: 20px;"></div>
                <!-- Plataforma -->
                <div class="platform green" style="left: 1300px; bottom: 150px; width: 180px; height: 20px;"></div>
                <div class="quicksand" id="quicksand4"></div>
                <!-- Runa 4 -->
                <div class="collectible" id="runa4"></div>
                <!-- Mensaje de Ayllu -->
                <div id="ayllu-warning">
                <div id="ayllu4-float"></div>
                <div id="ayllu4-text">Cuidado con las arenas movedizas, si te caes lo lamentar谩s...</div>
                </div>
            </div>
            
            
            <!-- Nivel 5 -->
            <div class="platforms-scene-5" style="display: none;">
                <!-- Plataforma inicial -->
                <div class="platform green" style="left: 80px; bottom: 180px; width: 160px; height: 20px;"></div>
                <!-- Plataforma mediana -->
                <div class="platform green" style="left: 350px; bottom: 320px; width: 120px; height: 20px;"></div>
                <!-- Plataforma peque帽a -->
                <div class="platform green" style="left: 600px; bottom: 220px; width: 70px; height: 20px;"></div>
                <div class="platform green" style="left: 900px; bottom: 180px; width: 20px; height: 20px;"></div>
                <div class="platform green" style="left: 1200px; bottom: 180px; width: 160px; height: 20px;"></div>
                <div class="quicksand" id="quicksand5"></div>
                <!-- Runa coleccionable -->
                <div class="collectible" id="runa5"></div>
            </div>
            
            <!-- Nivel 6 -->
            <div class="platforms-scene-6" style="display: none;">
                <!-- Plataformas en zigzag -->
                <div class="platform" style="left: 100px; bottom: 150px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 300px; bottom: 290px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 500px; bottom: 150px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 700px; bottom: 290px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 900px; bottom: 150px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 1100px; bottom: 290px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 1300px; bottom: 150px; width: 120px; height: 20px;"></div>
                <div class="platform" style="left: 1500px; bottom: 220px; width: 120px; height: 20px;"></div>

                <div class="spanish-enemy" style="left: 670px; bottom: 100px;"></div>
                <div class="spanish-enemy" style="left: 1122px; bottom: 310px;"></div>
                
                <!-- Runa coleccionable -->
                <div class="collectible" id="runa6"></div>
            </div>
            
            
            <!-- Nivel 7 -->
            <div class="platforms-scene-7" style="display: none;">
                <!-- Plataformas verticales -->
                <div class="platform" style="left: 200px; bottom: 100px; width: 80px; height: 20px;"></div>
                <div class="platform" style="left: 300px; bottom: 200px; width: 80px; height: 20px;"></div>
                <div class="platform" style="left: 400px; bottom: 300px; width: 80px; height: 20px;"></div>
                <div class="platform" style="left: 500px; bottom: 400px; width: 80px; height: 20px;"></div>

                <div class="platform" style="left: 1150px; bottom: 100px; width: 80px; height: 20px;"></div>
                <div class="platform" style="left: 1150px; bottom: 200px; width: 80px; height: 20px;"></div>
                <div class="platform" style="left: 1150px; bottom: 300px; width: 80px; height: 20px;"></div>
                <div class="platform" style="left: 1150px; bottom: 400px; width: 80px; height: 20px;"></div>
                
                <div class="platform" style="left: 900px; bottom: 200px; width: 80px; height: 20px;"></div>
                <div class="platform" style="left: 800px; bottom: 300px; width: 80px; height: 20px;"></div>
                
                <div class="spanish-enemy" style="left: 1150px; bottom: 120px;"></div>
                <div class="spanish-enemy" style="left: 1150px; bottom: 220px;"></div>
                <div class="spanish-enemy" style="left: 1150px; bottom: 320px;"></div>

                <div class="collectible" id="runa7"></div>
            </div>
            
            <!-- Nivel 8 -->
             
            <div class="platforms-scene-8" style="display: none;">
                
                <div class="platform moving" style="left: 600px; bottom: 150px; width: 100px; height: 20px;"></div>
                <div class="platform moving" style="left: 800px; bottom: 250px; width: 100px; height: 20px;"></div>
                <div class="platform moving" style="left: 1000px; bottom: 350px; width: 100px; height: 20px;"></div>
                <div class="platform" style="left: 1200px; bottom: 450px; width: 180px; height: 20px;"></div>
    
                <div class="collectible" id="runa8"></div>
            </div>
            
            <div id="eagleBoss" style="display: none;">
                <div class="boss" id="eagle"></div>
            <img id="feather-sprite" src="Resources/First_Boss/eagle_atk_mag.png" style="display:none">
            </div>
            <div class="collectible" id="runa1" style="left: 700px; bottom: 180px;"></div>
            <div class="character" id="player"></div>
            <!--Integraci贸n de Ayllu-->
            <div class="companion" id="ayllu">
                <div class="npc-label">Presiona 'B'</div>
            </div>
            <div class="scene-trigger" id="trigger1"></div>
            <div class="enemy" id="puma" style="display: none;"></div>
            <div id="life-bar">
                <img id="lifeImage" src="Resources/vida4.png" />
            </div>
            <!-- Contador de sabidur铆a -->
            <div id="wisdom-bar">
                <span id="wisdom-label">Sabidur铆a:</span>
                <span id="wisdom-points">0</span>
            </div>
            <div id="eagle-life-bar" style="display: none;">
                <img id="eagleLifeImage" src="Resources/vida_full_eagle.png" />
            </div>
            <div id="gameOverScreen" style="display: none;">
                 <h1>Game Over</h1>
                 <p>Has perdido todas tus vidas.</p>
            </div>
            <!-- Mensaje central para aciertos/errores -->
            <div id="centerMessage" style="display: none;">
                <p id="centerMessageText"></p>
            </div>
            <div class="blocker" style="left: 1250px; bottom: 100px;"></div>
            <!-- Cuadro de pregunta tipo quiz -->
            <div id="quiz-container" style="display: none;">
                <div id="quiz-box">
                     <p id="quiz-question">Pregunta aqu铆...</p>
                    <ul id="quiz-options">
                        <li class="quiz-option selected">Opci贸n 1</li>
                        <li class="quiz-option">Opci贸n 2</li>
                        <li class="quiz-option">Opci贸n 3</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- Quiz de Runas -->
    <div id="runa-quiz-container" style="display: none;">
        <div id="runa-quiz-box">
            <p id="runa-quiz-question"></p>
            <ul id="runa-quiz-options"></ul>
        </div>
    </div>
    <div id="overlay"></div>
    <div id="introScene">
        <div id="introText"></div>
        <div id="continuePrompt" style="display: none;">Presiona 'B' para continuar</div>
    </div>
    <!-- Modal para guardar score -->
    <div id="saveScoreModal" aria-hidden="true">
      <form id="saveScoreForm">
        <div id="saveScoreBox">
          <h3>Guardar puntuaci贸n</h3>
          <label>Usuario:</label>
          <input id="usernameInput" type="text" required maxlength="20" />
          <label>Nombre real:</label>
          <input id="realnameInput" type="text" required maxlength="40" />
          <label>Puntuaci贸n:</label>
          <input id="scoreInput" type="number" readonly />
          <label>Fecha:</label>
          <input id="dateInput" type="text" readonly />
          <div class="row">
            <button type="submit">Guardar</button>
            <button type="button" id="modalCancel">Cancelar</button>
          </div>
          <div id="saveScoreMessage"></div>
        </div>
      </form>
    </div>
    <script src="func.js"></script>
</body>
</html>