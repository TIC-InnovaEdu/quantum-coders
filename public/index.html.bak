<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Runa Pachawan - Grupo 10</title>
    <link rel="stylesheet" href="estilos.css" />
    <!-- Firebase (compat) SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
      // --- Tu firebaseConfig (tal como me lo pasaste) ---
      const firebaseConfig = {
        apiKey: "AIzaSyDAEwufyWjRtxvWpG3XiVD1TekeABK6Yjs",
        authDomain: "quantum-coders-3d4ca.firebaseapp.com",
        projectId: "quantum-coders-3d4ca",
        storageBucket: "quantum-coders-3d4ca.firebasestorage.app",
        messagingSenderId: "870775316580",
        appId: "1:870775316580:web:f62da8a3e62615eccc3f71",
        measurementId: "G-551EQ283PK"
      };

      // Inicializa Firebase (compat)
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Función que guarda en Firestore
      async function guardarScoreFirestore(nombre, user, score) {
        try {
          // Si existe window.finalGameData (la llenamos en func.js), úsala
          const meta = (typeof window.finalGameData !== 'undefined') ? window.finalGameData : {
            score: Number(score) || 0,
            wisdomPoints: Number(score) || 0,
            levelReached: null,
            runasCollected: 0,
            enemiesDefeated: 0,
            timestamp: new Date().toISOString()
          };

          // Sobre-escribe nombre/user con lo que pase el modal
          meta.nombre = nombre || meta.nombre || null;
          meta.user = user || meta.user || 'anon';

          // Asegurarnos types
          meta.score = Number(meta.score) || 0;
          meta.wisdomPoints = Number(meta.wisdomPoints) || meta.score || 0;
          meta.createdAt = firebase.firestore.FieldValue.serverTimestamp();

          const docRef = await db.collection('scores').add(meta);
          return { ok: true, id: docRef.id };
        } catch (err) {
          return { ok: false, error: err };
        }
      }

      /* ---------- Interfaz modal ---------- */
      const modal = document.getElementById('saveScoreModal');
      const modalScoreEl = document.getElementById('modalScore');
      const modalNombre = document.getElementById('modalNombre');
      const modalUser = document.getElementById('modalUser');
      const modalSave = document.getElementById('modalSave');
      const modalCancel = document.getElementById('modalCancel');
      const saveScoreMessage = document.getElementById('saveScoreMessage');

      let currentFinalScore = 0;

      function openSaveModal(score=0){
        currentFinalScore = score || 0;
        modalScoreEl.textContent = currentFinalScore;
        modalNombre.value = '';
        modalUser.value = '';
        saveScoreMessage.textContent = '';
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
        modalUser.focus();
      }

      function closeSaveModal(){
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
      }

      modalCancel.addEventListener('click', () => {
        closeSaveModal();
      });

      modalSave.addEventListener('click', async () => {
        const nombre = modalNombre.value.trim();
        const user = modalUser.value.trim();
        if(!user){
          saveScoreMessage.textContent = 'El campo "User / Apellido" es obligatorio.';
          return;
        }
        saveScoreMessage.textContent = 'Guardando...';
        const res = await guardarScoreFirestore(nombre, user, currentFinalScore);
        if(res.ok){
          saveScoreMessage.textContent = 'Puntuación guardada ✅';
          setTimeout(() => {
            closeSaveModal();
          }, 900);
        } else {
          saveScoreMessage.textContent = 'Error al guardar: ' + (res.error && res.error.message ? res.error.message : res.error);
        }
      });

      /* ---------- Función pública para llamar desde func.js ---------- */
      // Llamar: window.promptSaveScore(finalScore)
      window.promptSaveScore = function(finalScore){
        openSaveModal(finalScore);
      };

      /* ---------- Detectar Game Over automáticamente (opcional) ---------- */
      // Observa cambios del #gameOverScreen y muestra modal
      const gameOverEl = document.getElementById('gameOverScreen');
      if(gameOverEl){
        const observer = new MutationObserver((mutations) => {
          for(const m of mutations){
            if(m.type === 'attributes' && m.attributeName === 'style'){
              const disp = window.getComputedStyle(gameOverEl).display;
              if(disp !== 'none'){
                // Si func.js define window.finalScore lo usará; si no, manda 0
                const s = (typeof window.finalScore !== 'undefined') ? window.finalScore : 0;
                openSaveModal(s);
              }
            }
          }
        });
        observer.observe(gameOverEl, { attributes: true, attributeFilter: ['style'] });
      }
    </script>

    <!-- TU CÓDIGO DEL JUEGO -->
    <!-- Asegúrate de que func.js pueda llamar a window.promptSaveScore(scoreFinal) cuando termine -->
    <script src="func.js"></script>
</body>
</html>
        closeSaveModal();
      });

      modalSave.addEventListener('click', async () => {
        const nombre = modalNombre.value.trim();
        const user = modalUser.value.trim();
        if(!user){
          saveScoreMessage.textContent = 'El campo "User / Apellido" es obligatorio.';
          return;
        }
        saveScoreMessage.textContent = 'Guardando...';
        const res = await guardarScoreFirestore(nombre, user, currentFinalScore);
        if(res.ok){
          saveScoreMessage.textContent = 'Puntuación guardada ✅';
          setTimeout(() => {
            closeSaveModal();
          }, 900);
        } else {
          saveScoreMessage.textContent = 'Error al guardar: ' + (res.error && res.error.message ? res.error.message : res.error);
        }
      });

      /* ---------- Función pública para llamar desde func.js ---------- */
      // Llamar: window.promptSaveScore(finalScore)
      window.promptSaveScore = function(finalScore){
        openSaveModal(finalScore);
      };

      /* ---------- Detectar Game Over automáticamente (opcional) ---------- */
      // Observa cambios del #gameOverScreen y muestra modal
      const gameOverEl = document.getElementById('gameOverScreen');
      if(gameOverEl){
        const observer = new MutationObserver((mutations) => {
          for(const m of mutations){
            if(m.type === 'attributes' && m.attributeName === 'style'){
              const disp = window.getComputedStyle(gameOverEl).display;
              if(disp !== 'none'){
                // Si func.js define window.finalScore lo usará; si no, manda 0
                const s = (typeof window.finalScore !== 'undefined') ? window.finalScore : 0;
                openSaveModal(s);
              }
            }
          }
        });
        observer.observe(gameOverEl, { attributes: true, attributeFilter: ['style'] });
      }
    </script>

    <!-- TU CÓDIGO DEL JUEGO -->
    <!-- Asegúrate de que func.js pueda llamar a window.promptSaveScore(scoreFinal) cuando termine -->
    <script src="func.js"></script>
</body>
</html>
